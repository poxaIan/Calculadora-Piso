<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Despesas de casamento</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Despesas de casamento</h1>

  <form id="formulario">
    <select name="categoria" required>
      <option value="">Selecione uma categoria</option>
      <option value="Buffet">Buffet</option>
      <option value="Decora√ß√£o">Decora√ß√£o</option>
      <option value="Fotografia">Fotografia</option>
      <option value="DJ / M√∫sica">DJ / M√∫sica</option>
      <option value="Convites">Convites</option>
    </select>
    <input type="number" name="valor" placeholder="Novo valor estimado" required>
    <button type="submit">Atualizar Despesa</button>
  </form>

  <h2>Distribui√ß√£o atual</h2>
  <p id="total"></p>
  <canvas id="grafico" width="400" height="400"></canvas>

  <script>
    const SHEETDB_URL = "https://sheetdb.io/api/v1/opi6fgc16nx4q";

    async function carregarGrafico() {
      console.log("üîÑ Carregando gr√°fico...");

      try {
        const res = await fetch(SHEETDB_URL);
        const dados = await res.json();
        console.log("üìä Dados recebidos do SheetDB:", dados);

        const categorias = [];
        const valores = [];

        dados.forEach(item => {
          const categoria = item.Categoria;
          const valor = Number(item.Valor_Estimado_R);
          if (categoria && !isNaN(valor)) {
            categorias.push(categoria);
            valores.push(valor);
          }
        });

        const total = valores.reduce((acc, val) => acc + val, 0);
        document.getElementById("total").innerText = `Total estimado: R$ ${total.toFixed(2)}`;
        console.log("‚úÖ Categorias:", categorias);
        console.log("‚úÖ Valores:", valores);

        const ctx = document.getElementById("grafico").getContext("2d");
        if (window.meuGrafico) window.meuGrafico.destroy();

        window.meuGrafico = new Chart(ctx, {
          type: "pie",
          data: {
            labels: categorias,
            datasets: [{
              label: "Gastos (R$)",
              data: valores
            }]
          }
        });
      } catch (err) {
        console.error("‚ùå Erro ao carregar dados do gr√°fico:", err);
      }
    }

    document.getElementById("formulario").addEventListener("submit", async (e) => {
      e.preventDefault();
      const categoria = e.target.categoria.value;
      const valor = e.target.valor.value;

      console.log(`üì§ Enviando PUT para atualizar categoria "${categoria}" com valor R$ ${valor}`);

      const url = `${SHEETDB_URL}/Categoria/${encodeURIComponent(categoria)}`;
      try {
        const resposta = await fetch(url, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ data: { Valor_Estimado_R: valor } })
        });

        const retorno = await resposta.json();
        console.log("‚úÖ Resposta do PUT:", retorno);

        e.target.reset();
        await carregarGrafico();
      } catch (err) {
        console.error("‚ùå Erro ao enviar PUT:", err);
      }
    });

    carregarGrafico();
  </script>
</body>
</html>
