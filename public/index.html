<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Despesas de casamento</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Despesas de casamento</h1>

  <form id="formulario">
    <select name="categoria" required>
      <option value="">Selecione uma categoria</option>
      <option value="Buffet">Buffet</option>
      <option value="Decoração">Decoração</option>
      <option value="Fotografia">Fotografia</option>
      <option value="DJ / Música">DJ / Música</option>
      <option value="Convites">Convites</option>
    </select>
    <input type="number" name="valor" placeholder="Novo valor estimado" required>
    <button type="submit">Atualizar Despesa</button>
  </form>

  <h2>Distribuição atual</h2>
  <p id="total"></p>
  <canvas id="grafico" width="400" height="400"></canvas>

  <script>
    const SHEETDB_URL = "https://sheetdb.io/api/v1/opi6fgc16nx4q";

    async function carregarGrafico() {
      const res = await fetch(SHEETDB_URL);
      const dados = await res.json();

      const categorias = [];
      const valores = [];

      dados.forEach(item => {
        const categoria = item.Categoria;
        const valor = Number(item.Valor_Estimado_R);
        if (
          categoria &&
          categoria.toLowerCase() !== 'totais:' &&
          !isNaN(valor)
        ) {
          categorias.push(categoria);
          valores.push(valor);
        }
      });

      // Mostrar total
      const total = valores.reduce((acc, val) => acc + val, 0);
      document.getElementById("total").innerText = `Total estimado: R$ ${total.toFixed(2)}`;

      const ctx = document.getElementById("grafico").getContext("2d");
      if (window.meuGrafico) window.meuGrafico.destroy();

      window.meuGrafico = new Chart(ctx, {
        type: "pie",
        data: {
          labels: categorias,
          datasets: [{
            label: "Gastos (R$)",
            data: valores
          }]
        }
      });
    }

    document.getElementById("formulario").addEventListener("submit", async (e) => {
      e.preventDefault();
      const categoria = e.target.categoria.value;
      const valor = e.target.valor.value;

      const url = `${SHEETDB_URL}/search?Categoria=${encodeURIComponent(categoria)}`;
      await fetch(url, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data: { Valor_Estimado_R: valor } })
      });

      e.target.reset();
      await carregarGrafico();
    });

    carregarGrafico();
  </script>
</body>
</html>
